name: Build Monochrome APK

on:
  push:
    branches:
      - claude/monochrome-mobile-apk-iXLGp
    paths:
      - monochrome-apk/**
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin

      - name: Grant execute permission for gradlew
        run: chmod +x monochrome-apk/gradlew

      - name: Build debug APK
        working-directory: monochrome-apk
        run: ./gradlew assembleDebug --no-daemon

      - name: Sign APK with debug key
        working-directory: monochrome-apk
        run: |
          APK_IN=app/build/outputs/apk/debug/app-debug.apk
          APK_OUT=monochrome.apk
          BUILD_TOOLS=$ANDROID_HOME/build-tools/$(ls $ANDROID_HOME/build-tools | sort -V | tail -1)
          $BUILD_TOOLS/zipalign -f -p 4 $APK_IN aligned.apk
          $BUILD_TOOLS/apksigner sign --ks ~/.android/debug.keystore --ks-pass pass:android --key-pass pass:android --ks-key-alias androiddebugkey --out $APK_OUT aligned.apk
          echo "APK signed"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: monochrome-apk
          path: monochrome-apk/monochrome.apk
          retention-days: 30

      - name: Commit updated APK to branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add monochrome-apk/monochrome.apk
          git diff --staged --quiet || git commit -m "chore: update monochrome.apk [skip ci]"
          git push
